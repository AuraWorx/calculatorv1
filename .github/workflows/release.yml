name: Release and Deploy

on:
  push:
    tags:
      - 'v*'

jobs:
  deploy-uat:
    runs-on: ubuntu-latest
    environment: uat
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install uv
      uses: astral-sh/setup-uv@v1
      with:
        version: "latest"
    
    - name: Create virtual environment
      run: uv venv

    - name: Install dependencies
      run: |
        source .venv/bin/activate
        uv pip install -r requirements.txt

    - name: Deploy to UAT Environment
      run: |
        echo "ğŸš€ Deploying version ${{ github.ref_name }} to UAT Environment..."
        echo "ğŸ“¦ Building application..."
        echo "ğŸ”§ Installing dependencies..."
        echo "ğŸš€ Starting UAT deployment..."
        echo "âœ… UAT Deploy done!"
        echo ""
        echo "ğŸŒ UAT Environment: https://uat-calculator-api.example.com"
        echo "ğŸ“Š Health Check: https://uat-calculator-api.example.com/health"
        echo "ğŸ·ï¸  Version: ${{ github.ref_name }}"

    - name: Wait for UAT approval
      run: |
        echo "â³ Waiting for approval to deploy to PROD..."
        echo "âœ… UAT deployment completed successfully"
        echo "ğŸ”’ PROD deployment requires manual approval"

  deploy-prod:
    runs-on: ubuntu-latest
    environment: production
    needs: deploy-uat
    if: github.ref == 'refs/tags/v*'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install uv
      uses: astral-sh/setup-uv@v1
      with:
        version: "latest"
    
    - name: Create virtual environment
      run: uv venv

    - name: Install dependencies
      run: |
        source .venv/bin/activate
        uv pip install -r requirements.txt

    - name: Deploy to Production Environment
      run: |
        echo "ğŸš€ Deploying version ${{ github.ref_name }} to PRODUCTION Environment..."
        echo "ğŸ“¦ Building application..."
        echo "ğŸ”§ Installing dependencies..."
        echo "ğŸš€ Starting PROD deployment..."
        echo "âœ… PROD Deploy done!"
        echo ""
        echo "ğŸŒ Production Environment: https://prod-calculator-api.example.com"
        echo "ğŸ“Š Health Check: https://prod-calculator-api.example.com/health"
        echo "ğŸ·ï¸  Version: ${{ github.ref_name }}"
        echo "ğŸ‰ Production deployment completed successfully!"

    - name: Notify deployment success
      run: |
        echo "ğŸ‰ Successfully deployed ${{ github.ref_name }} to production!"
        echo "ğŸ“¢ Sending notifications..."
        echo "âœ… All environments updated successfully"
